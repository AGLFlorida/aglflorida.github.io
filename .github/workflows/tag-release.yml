name: Tag Release

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]

permissions:
  contents: write

jobs:
  tag-release:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get Latest Git Tag or First Commit
        id: latest_tag
        run: |
          if git describe --tags --abbrev=0 > /dev/null 2>&1; then
            echo "tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT
          else
            echo "tag=$(git rev-list --max-parents=0 HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Compute Next Version
        id: version
        run: |
          current_tag="${{ steps.latest_tag.outputs.tag }}"
          if [[ "$current_tag" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            major="${BASH_REMATCH[1]}"
            minor="${BASH_REMATCH[2]}"
            patch="${BASH_REMATCH[3]}"
            new_tag="v$major.$minor.$((patch + 1))"
            version_only="$major.$minor.$((patch + 1))"
          else
            new_tag="v0.1.0"
            version_only="0.1.0"
          fi
          echo "tag=$new_tag" >> $GITHUB_OUTPUT
          echo "version_only=$version_only" >> $GITHUB_OUTPUT

      - name: Set version in package.json
        run: |
          jq --arg v "${{ steps.version.outputs.version_only }}" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json

      - name: Refresh lockfile
        run: npm install

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit and Push Version Bump
        run: |
          git add package.json package-lock.json
          if git diff --cached --quiet; then
            echo "No version change to commit."
            exit 0
          fi
          commit_message="chore: bump version to ${{ steps.version.outputs.version_only }} [skip ci]"
          sanitized_message=$(echo "$commit_message" | tr -d '\n' | sed 's/[^[:print:]]//g')
          git commit -m "$sanitized_message"
          git push

      - name: Tag Release Commit
        run: |
          tag="${{ steps.version.outputs.tag }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists. Skipping."
            exit 0
          fi
          git tag -a "$tag" -m "Release $tag"
          git push origin "$tag"
